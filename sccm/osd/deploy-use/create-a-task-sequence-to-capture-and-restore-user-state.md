---
title: "ユーザー状態をキャプチャおよび復元するタスク シーケンスの作成 | Microsoft Docs"
description: "System Center Configuration Manager のタスク シーケンスを使用してオペレーティング システムの展開シナリオでのユーザー状態のデータをキャプチャして復元します。"
ms.custom: na
ms.date: 06/07/2017
ms.prod: configuration-manager
ms.reviewer: na
ms.suite: na
ms.technology:
- configmgr-osd
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: d566d85c-bf7a-40e7-8239-57640a1db5f4
caps.latest.revision: 7
caps.handback.revision: 0
author: Dougeby
ms.author: dougeby
manager: angrobe
ms.translationtype: Human Translation
ms.sourcegitcommit: c6ee0ed635ab81b5e454e3cd85637ff3e20dbb34
ms.openlocfilehash: 4b3668094d576b1b8710f08b384aa2f7c5eb0cca
ms.contentlocale: ja-jp
ms.lasthandoff: 06/08/2017


---
# System Center Configuration Manager でユーザー状態をキャプチャおよび復元するためのタスク シーケンスを作成する
<a id="create-a-task-sequence-to-capture-and-restore-user-state-in-system-center-configuration-manager" class="xliff"></a>

*適用対象: System Center Configuration Manager (Current Branch)*

オペレーティング システムを展開するときに、現在のオペレーティング システムのユーザー状態を維持したい場合は、System Center Configuration Manager のタスク シーケンスを使って、ユーザー状態データをキャプチャして復元します。 作成するタスク シーケンスの種類によっては、タスク シーケンスの一部として、キャプチャの作成と復元のステップが自動的に追加されることがあります。 他のシナリオでは、タスク シーケンスにキャプチャと復元のステップを手動で追加する必要があります。 このトピックでは、ユーザー状態データをキャプチャして復元するために、既存のタスク シーケンスに追加する必要があるステップを示します。  

##  <a name="BKMK_CaptureRestoreUserState"></a> ユーザー状態データのキャプチャおよび復元方法  
 ユーザー状態をキャプチャして復元するには、タスク シーケンスに、次のステップを追加する必要があります。  

-   **状態ストアの要求**: 状態移行ポイントにユーザー状態を保存する場合に限り、このステップが必要となります。  

-   **ユーザー状態のキャプチャ**: このステップでは、ユーザー状態データをキャプチャし、状態移行ポイントに保存するか、リンクを使用してローカルに保存します。  

-   **ユーザー状態の復元**: このステップでは、ユーザー状態データを展開先コンピューターに復元します。 ユーザー状態移行ポイントまたは展開先コンピューターからデータを取得できます。  

-   **状態ストアのリリース**: 状態移行ポイントにユーザー状態を保存する場合に限り、このステップが必要です。 このステップでは、状態移行ポイントからこのデータを削除します。  

 次の手順に従い、ユーザー状態のキャプチャと復元に必要なタスク シーケンスのステップを追加します。 タスク シーケンスの作成の詳細については、「[タスクを自動化するためのタスク シーケンスの管理](manage-task-sequences-to-automate-tasks.md)」を参照してください。  

#### ユーザー状態をキャプチャするタスク シーケンスのステップを追加するには
<a id="to-add-task-sequence-steps-to-capture-the-user-state" class="xliff"></a>  

1.  [ **タスク シーケンス** ] 一覧で、タスク シーケンスを選択し、[ **編集**] をクリックします。  

2.  状態移行ポイントを使用してユーザー状態を保存するには、[状態ストアの要求] ステップをタスク シーケンスに追加します。 **** [タスク シーケンス エディター] ダイアログ ボックス **** で、[追加 ****] をクリックし、[ユーザー状態 ****] をポイントしてから、[ユーザー状態の要求 ****] をクリックします。 [ **状態ストアの要求** ] 手順について、次のプロパティとオプションを指定し、[ **適用**] をクリックします。  

     [プロパティ] タブで、次のオプションを指定します。 ****   

    -   ステップの名前と説明を入力します。  

    -   [状態をコンピューターからキャプチャする] をクリックします。 ****  

    -   [再試行の回数] ボックスで、エラーが発生した場合にタスク シーケンスがユーザー状態のキャプチャを試行する回数を指定します。 ****  

    -   [再試行の待ち時間 (秒)] ボックスで、タスク シーケンスがデータのキャプチャを再試行するまで待機する秒数を指定します。 ****  

    -   状態ストアへの接続に Configuration Manager [ネットワーク アクセス アカウント](../../core/plan-design/hierarchy/manage-accounts-to-access-content.md#a-namebkmknaaa-network-access-account)を使用するかどうかを指定するには、[**コンピューター アカウントで状態ストアに接続できない場合、ネットワーク アクセス アカウントを使用する**] チェック ボックスをオンにします。  

     [オプション **** ] タブで、次のオプションを指定します。  

    -   このステップが失敗した場合にタスク シーケンスが次のステップに進むようにするには、[エラー時に続行する **** ] チェック ボックスをオンにします。  

    -   エラーが発生した場合に、タスク シーケンスが続行するために満たす必要のある条件を指定します。  

3.  [ユーザー状態のキャプチャ] ステップをタスク シーケンスに追加します。 **** [タスク シーケンス エディター] **** ダイアログ ボックスで、[追加 ****] をクリックし、[ユーザー状態 ****] をポイントしてから、[ユーザー状態のキャプチャ ****] をクリックします。 [ **ユーザー状態のキャプチャ** ] 手順について、次のプロパティとオプションを指定し、[ **OK**] をクリックします。  

    > [!IMPORTANT]  
    >  タスク シーケンスにこの手順を追加する場合、 **OSDStateStorePath** タスク シーケンス変数を設定して、ユーザー状態データの保存場所を指定します。 ユーザー状態をローカルに保存する場合は、ルート フォルダーを指定しないでください。タスク シーケンスが失敗する可能性があります。 ユーザー データをローカルに保存する場合は、常にフォルダーまたはサブフォルダーを使用してください。 この変数については、「[ユーザー状態のキャプチャ タスク シーケンス アクション変数](../understand/task-sequence-action-variables.md#BKMK_CaptureUserState)」を参照してください。  

     [プロパティ] タブで、次のオプションを指定します。 ****   

    -   ステップの名前と説明を入力します。  

    -   ユーザー状態データのキャプチャに使用する USMT ソース ファイルを含むパッケージを指定します。  

    -   キャプチャするユーザー プロファイルを指定します。  

        -   すべてのユーザー プロファイルをキャプチャするには、[標準オプションを使用してすべてのユーザー プロファイルをキャプチャする] をクリックします。 ****  

        -   キャプチャするユーザー プロファイルを個別に指定するには、[ユーザー プロファイルのキャプチャ方法をカスタマイズする] をクリックします。 **** ユーザー プロファイル情報を含む構成ファイル (miguser.xml、migsys.xml、または migapp.xml) を選択します。 ここでは config.xml 構成ファイルを使用できませんが、OSDMigrageAdditionalCaptureOptions 変数と OSDMigrateAdditionalRestoreOptions 変数を使用して、USMT コマンド ラインに手動で追加することができます。

    -   [詳細ログ記録を有効にする **** ] を選択し、エラーが発生した場合にどのくらいの情報をログに書き込むかを指定します。  

    -   [暗号化されたファイル システム (EFS) を使用するファイルをスキップする] をオンにします。 ****  

    -   次の設定を指定するには、[ファイル システム アクセスを使用してコピーする] をオンにします。 ****  

        -   **キャプチャできないファイルがあっても続行する**: この設定では、タスク シーケンス手順が一部のファイルをキャプチャできない場合でも移行処理を続行できます。 このオプションを無効にし、ファイルをキャプチャできない場合、タスク シーケンスのステップは失敗します。 既定では、このオプションは有効になっています。  

        -   **ファイルをコピーする代わりに、リンクを使用してローカルでキャプチャする**: この設定では、USMT 4.0 で使用可能なハード リンク移行機能を使用することができます。 USMT 4.0 より前のバージョンの USMT を使用している場合、この設定は無視されます。  

        -   **オフライン モードでキャプチャする (Windows PE のみ)**: この設定では、既存のオペレーティング システムを起動せずに、Windows PE からユーザー状態をキャプチャできます。 USMT 4.0 より前のバージョンの USMT を使用している場合、この設定は無視されます。  

    -   [Volume Copy Shadow Services (VSS) を使用してキャプチャする] ****を選択します。 USMT 4.0 より前のバージョンの USMT を使用している場合、この設定は無視されます。  

     [オプション **** ] タブで、次のオプションを指定します。  

    -   このステップが失敗した場合にタスク シーケンスが次のステップに進むようにするには、[エラー時に続行する **** ] チェック ボックスをオンにします。  

    -   エラーが発生した場合に、タスク シーケンスが続行するために満たす必要のある条件を指定します。  

4.  状態移行ポイントを使用してユーザー状態を保存する場合は、タスク シーケンスに、[[状態ストアのリリース](../understand/task-sequence-steps.md#BKMK_ReleaseStateStore)] ステップを追加します。 [タスク シーケンス エディター **** ] ダイアログ ボックスで [追加 ****] をクリックし、[ユーザー状態 ****] を選択してから [状態ストアのリリース ****] をクリックします。 [状態ストアのリリース **** ] 手順について次のプロパティとオプションを指定し、[OK ****] をクリックします。  

    > [!IMPORTANT]  
    >  [状態ストアのリリース **** ] 手順の開始前に実行するタスク シーケンス アクションは、正常に実行できる必要があります。 ****  

     [プロパティ **** ] タブに手順の名前と説明を入力します。  

     [オプション **** ] タブで、次のオプションを指定します。  

    -   このステップが失敗した場合にタスク シーケンスが次のステップに進むようにするには、[エラー時に続行する **** ] チェック ボックスをオンにします。  

    -   エラーが発生した場合に、タスク シーケンスが続行するために満たす必要のある条件を指定します。  

 このタスク シーケンスを展開し、展開先コンピューターでユーザー状態をキャプチャします。 タスク シーケンスの展開方法の詳細については、「[タスク シーケンスの展開](../deploy-use/manage-task-sequences-to-automate-tasks.md#BKMK_DeployTS)」を参照してください。  

#### ユーザー状態を復元するタスク シーケンスのステップを追加するには
<a id="to-add-task-sequence-steps-to-restore-the-user-state" class="xliff"></a>  

1.  [ **タスク シーケンス** ] 一覧で、タスク シーケンスを選択し、[ **編集**] をクリックします。  

2.  [[ユーザー状態の復元](../understand/task-sequence-steps.md#BKMK_RestoreUserState)] ステップをタスク シーケンスに追加します。 [タスク シーケンス エディター] **** ダイアログ ボックスで、[追加 ****] をクリックし、[ユーザー状態 ****] をポイントしてから、[ユーザー状態の復元 ****] をクリックします。 このステップでは、状態移行ポイントへの接続を確立します。 [ **ユーザー状態の復元** ] 手順について、次のプロパティとオプションを指定し、[ **OK**] をクリックします。  

     [プロパティ] タブで、次のプロパティを指定します。 ****   

    -   ステップの名前と説明を入力します。  

    -   ユーザー状態データを復元する USMT を含むパッケージを指定します。  

    -   復元するユーザー プロファイルの指定:  

        -   [キャプチャしたすべてのユーザー プロファイルを標準オプションを使用して復元する **** ] をクリックし、ユーザー プロファイルをすべて復元します。  

        -   **[Customize user profile restore]\(ユーザー プロファイルの復元方法をカスタマイズする\)** をクリックし、個別のユーザー プロファイルを復元します。 ユーザー プロファイル情報を含む構成ファイル (miguser.xml、migsys.xml、または migapp.xml) を選択します。 ここでは config.xml 構成ファイルを使用できませんが、OSDMigrageAdditionalCaptureOptions 変数と OSDMigrateAdditionalRestoreOptions 変数を使用して、USMT コマンド ラインに手動で追加することができます。

    -   [ローカル コンピューターのユーザー プロファイルを復元する **** ] を選択し、復元したプロファイルの新しいパスワードを入力します。 ローカル プロファイルのパスワードは移行できません。  

        > [!NOTE]  
        >  ローカル ユーザー アカウントがあり、[[ユーザー状態のキャプチャ](../understand/task-sequence-steps.md#BKMK_CaptureUserState)] ステップを使用して、[**すべてのユーザー プロファイルを標準オプションでキャプチャする**]を選択する場合、[[ユーザー状態の復元](../understand/task-sequence-steps.md#BKMK_RestoreUserState)] ステップで、[**ローカル コンピューターのユーザー プロファイルを復元する**] 設定を選択する必要があります。そうしないと、タスク シーケンスは失敗します。  

    -   ファイルを復元できない状態で [ユーザー状態の復元 **** ] 手順を続行する場合は、[復元できないファイルがあっても続行する **** ] を選択します。  

         ローカル リンクを使用してユーザー状態を保存しており、正常に復元できなかった場合、管理者ユーザーは作成されたハードリンクを手動で削除してデータを復元できます。あるいは、タスク シーケンスで USMTUtils ツールを実行することもできます。 USMTUtils を使用してハードリンクを削除する場合は、USMTUtils を実行してから [[コンピューターの再起動](../understand/task-sequence-steps.md#a-namebkmkrestartcomputera-restart-computer)] ステップを追加します。  

    -   [詳細ログ記録を有効にする **** ] を選択し、エラーが発生した場合にどのくらいの情報をログに書き込むかを指定します。  

     [オプション **** ] タブで、次のオプションを指定します。  

    -   このステップが失敗した場合にタスク シーケンスが次のステップに進むようにするには、[エラー時に続行する **** ] チェック ボックスをオンにします。  

    -   エラーが発生した場合に、タスク シーケンスが続行するために満たす必要のある条件を指定します。  

3.  状態移行ポイントを使用してユーザー状態を保存する場合は、タスク シーケンスに、[[状態ストアのリリース](../understand/task-sequence-steps.md#BKMK_ReleaseStateStore)] ステップを追加します。 [タスク シーケンス エディター **** ] ダイアログ ボックスで [追加 ****] をクリックし、[ユーザー状態 ****] を選択してから [状態ストアのリリース ****] をクリックします。 [状態ストアのリリース **** ] 手順について次のプロパティとオプションを指定し、[OK ****] をクリックします。  

    > [!IMPORTANT]  
    >  [状態ストアのリリース **** ] 手順の開始前に実行するタスク シーケンス アクションは、正常に実行できる必要があります。 ****  

     [プロパティ **** ] タブに手順の名前と説明を入力します。  

     [オプション **** ] タブで、次のオプションを指定します。  

    -   このステップが失敗した場合にタスク シーケンスが次のステップに進むようにするには、[エラー時に続行する **** ] チェック ボックスをオンにします。  

    -   エラーが発生した場合に、タスク シーケンスが続行するために満たす必要のある条件を指定します。  

 このタスク シーケンスを展開し、対象コンピューターでユーザー状態を復元します。 タスク シーケンスの詳細については、「[タスク シーケンスの展開](manage-task-sequences-to-automate-tasks.md#BKMK_DeployTS)」を参照してください。  

## 次のステップ
<a id="next-steps" class="xliff"></a>
[タスク シーケンスの展開の監視](monitor-operating-system-deployments.md#BKMK_TSDeployStatus)

